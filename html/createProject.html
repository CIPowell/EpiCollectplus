{{style}}	
{{/style}}

{{script}}
  <script type="text/javascript">
  	var obj;
  	var publicOpts;
  	var listOpts;
  	var curEmail = "{#userEmail#}";
  	
  	$(function(){
  		publicOpts = $('#public').buttonset();
  		listOpts = $('#listed').buttonset();
  		$('.panelSwitcher, .button').button();
		$('#pdNext').button("disable");
		
 		
		$('input[name=name]').on('change', function(evt){
			if($('.projectName').text() != '') return;
			
			$.ajax({
				url: './' + $(evt.target).val(),
				error: function(xhr, status, s){
					$('#pdNext').button("enable");
					$(evt.target).removeClass('ecplus-invalid');
					$('#projectNameMsg').html('<p class="msg">Project name available.</p>');
				},
				success: function(){
					$('#pdNext').button("disable");
					
					$(evt.target).addClass('ecplus-invalid');
					$('#projectNameMsg').html('<p class="err">Project name is already in use. Project name must be unique.</p>');
				}
			});
		});
		
		$('#uploadxml').on('load', function(){
			var doc = ($('#uploadxml')[0].contentWindow.document || $('#uploadxml')[0].contentDocument);
			var frm = doc.forms[0]; 

			if(frm)
			{
				$(frm.xml).change(function(){
		  			frm.submit();
		  		});
			}
			$('#uploadxml').on('load', function(){
				var cw_url = $('#uploadxml')[0].contentWindow.location.href;
				var doc = ($('#uploadxml')[0].contentWindow.document || $('#uploadxml')[0].contentDocument);
				if(cw_url == location.protocol + '//' + location.host + "{#SITE_ROOT#}/html/projectIFrame.html") return;
					
				$('#uploadStatus').empty();
	  			/*try{*/
	  				obj = JSON.parse($(doc.body).text());
	  			/*}catch(err){
	  				obj = false;
	  			}*/
	  			
	  			if(!obj || !obj.valid){
	  				
	  				if(cw_url != location.protocol + '//' + location.host + "{#SITE_ROOT#}/html/projectIFrame.html") {$('#uploadxml')[0].src = "{#SITE_ROOT#}/html/projectIFrame.html";}
	  				$('#uploadxml').show();
	  				//show error messages
	  				$('#uploadStatus').addClass("err");
	  				$('#uploadStatus').removeClass("go");
	  				$('#uploadStatus').append("<p>" + obj.msgs.join("</p><p>") + "</p>");
	  				if(!$('input[name=name]').val()) $('#pdNext').button("disable");
	  			}
	  			else
	  			{
	  				if(cw_url != location.protocol + '//' + location.host + "{#SITE_ROOT#}/html/projectIFrame.html") {$('#uploadxml')[0].src = "{#SITE_ROOT#}/html/projectIFrame.html";}
	  				$('#uploadStatus').addClass("go");
	  				$('#uploadStatus').removeClass("err");
	  			
	  				$('#uploadStatus').append("XML is valid for the project " + obj.name);
	  				$('.projectName').text(obj.name);
	  				$(document.forms[0].xml).val(obj.file);
	  				$('#pdNext').button("enable");
	  			}
	  			
	  		});
		})
  		
  		goTo('projectDef');
		
		$('#pdNext').mouseover(function(evt){
			$('input[name=name]').change();
		});
		
		$('#uploadBox').accordion({
			collapsible : true,
			active: false,
			heightStyle : 'content'
		});
  	});
  	
 	
  	
  	
  </script>
{{/script}}
{{breadcrumbs}}
  &gt; <a href="createProject.html">Create Project</a>
{{/breadcrumbs}}
{{main}}
    <div class="row">
        <div class="span12">
            <h1 id="title">Create a Project - <span class="projectName"></span></h1>
            <div id="message" class="flashes"></div>
            <h2>Project Definition</h2>
        </div>
    </div>
    <form id="projectOptions" action="create" method="POST">
        <div class="row choose">
            <div class="span5">
                 <h3>Choose a name for the project</h3>
                 <input name="name" />
                 <div id="projectNameMsg"></div>
            </div>
            <div class="span2">
                <h2>OR</h2>
            </div>
            <div id="uploadBox" class="span5">
                
                    <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#uploadpanel">Upload an existing EpiCollect project definition</button>
                    <div id="uploadpanel" class="collapse">
                        <iframe id="uploadxml" src="{#SITE_ROOT#}/html/projectIFrame.html"></iframe>
                        <div id="uploadStatus" class="flash"></div>	
                        <input type="hidden" name="xml"/>
                    </div>
             </div>
        </div>
        <div class="row">
            <div class="span12">
                <h2>Project Access</h2>

                <p></p>

                <a href="javascript:document.forms[0].submit();"> Create Project </a>	
            </div>	
        </div>
	</form>
    </div>
{{/main}}